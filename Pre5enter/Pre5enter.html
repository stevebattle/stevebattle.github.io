<html>
    <head>
        <title>Pre5enter</title>
        <!-- author: https://github.com/stevebattle/ -->
        <style>
            .centre {
                margin: 0;
                position: absolute;
                top: 50%;
                left: 50%;
                -ms-transform: translate(-50%, -50%);
                transform: translate(-50%, -50%);
            }
        </style>
    </head>
    <body>
        <div class="centre">
            <iframe id="iframe" style="border:none;"></iframe>
        </div>
        <script>
            function getJSON(url, callback) {
                var req = new XMLHttpRequest() ;
                req.open('GET', url, false ) ;
                req.onload = function() {
                    if (req.status == 200) {
                        callback(null, JSON.parse(req.responseText)) ;
                    } else {
                        callback(req.status, null) ;
                    }
                };
                req.send() ;
            }

            function change() {
                f.height = conf.clips[i].height || conf.default.height ; 
                f.width = conf.clips[i].width || conf.default.width ;
                base = conf.clips[i].base ;
                source = conf.clips[i].src ;
                if (source.isArray()) { // multiple P5 source files
                    srcdoc = "<html><div id='sketch'><\/div><script src='libraries/p5.js'>" ;
                    for (n=0; n<source.length; n++) {
                        s = source[n] ;
                        if (base && !s.startsWith('http')) {
                            s = base + s;
                        }
                        srcdoc += "<script src='" + s + "'><\/script>" ;
                    }
                    srcdoc += "<\/html>" ;
                    f.srcdoc = srcdoc ;
                }
                else if (source.endsWith(".js")) { // Processing P5 source
                    f.srcdoc = "<html><div id='sketch'><\/div><script src='libraries/p5.js'><\/script><script src='" + 
                    source + "'><\/script><\/html>" ;
                } 
                else if (source.endsWith(".gif") || source.endsWith(".jpeg")  || source.endsWith(".jpg")) { 
                    // (animated) gif, jpeg image
                    f.srcdoc = "<html><img width=" + f.width + " height=" + f.height + " src='" + source + "'><\/html>" ;                 
                } 
                else { // default is html (may be implied index.html)
                    // srcdoc overrides src
                    f.removeAttribute("srcdoc") ;
                    f.src = source ;
                }
                background = conf.clips[i].background || conf.default.background ;
                document.body.style.backgroundColor = background ;
                duration = conf.clips[i].duration || conf.default.duration ;
                i = (i+1) % conf.clips.length ;
                setTimeout(change, duration * 1000) ;
            }

            var conf ;
            var query = window.location.search.substring(1) ;
            dataURL = query.split("=")[1]; // conf parameter
            // CORS is supported by github. Verify this with:
            // curl -I https://stevebattle.github.io/Pre5enter/Pre5enter.json
            //dataURL = "https://stevebattle.github.io/Pre5enter/Pre5enter.json" ;
            var f = document .getElementById("iframe");
            var i = 0;
            getJSON(dataURL, function(err, data) {
                if (err != null) {
                    alert('Cannot load Pre5enter data: ' + err);
                } else {
                    conf = data ;
                    change();
                }
            });
        </script>
    </body>
</html>
<html>
    <head>
        <title>Pre5enter</title>
        <!-- author: https://github.com/stevebattle/ -->
        <style>
            .centre {
                margin: 0;
                position: absolute;
                top: 50%;
                left: 50%;
                -ms-transform: translate(-50%, -50%);
                transform: translate(-50%, -50%);
            }
        </style>
    </head>
    <body>
        <div class="centre">
            <iframe id="iframe" style="border:none;"></iframe>
        </div>
        <script>
            // get parsed JSON configuration
            function getJSON(url, callback) {
                var req = new XMLHttpRequest() ;
                req.open('GET', url, false ) ;
                req.onload = function() {
                    if (req.status == 200) {
                        callback(null, JSON.parse(req.responseText)) ;
                    } else {
                        callback(req.status, null) ;
                    }
                };
                req.send() ;
            }

            // change the currently displayed clip
            function change() {
                // parameters can be set in default or individual clips
                f.height = conf.clips[i].height || conf.default.height ; 
                f.width = conf.clips[i].width || conf.default.width ;

                source = conf.clips[i].src ;
                if (Array.isArray(source) || source.endsWith(".js")) { // single or multiple P5 source files
                    srcdoc = "<html>" ;
                    // set base in the head
                    if (conf.clips[i].base) {
                        srcdoc += "<head><base href='"+ conf.clips[i].base +"'><\/base><\/head>" ;
                    }
                    srcdoc += "<body>" ;
                    // define P5 sketch canvas
                    srcdoc += "<div id='sketch'><\/div>" ;
                    // load P5 framework
                    srcdoc += "<script language='javascript' type='text/javascript' src='libraries/p5.js'><\/script>" ;
                    // load P5 scripts
                    if (Array.isArray(source)) {
                        for (n=0; n<source.length; n++) {
                            srcdoc += "<script language='javascript' type='text/javascript' src='" + 
                            source[n] + "'><\/script>" ;
                        }
                    }
                    else {
                        srcdoc += "<script src='" + source + "'><\/script>" ;
                    }
                    srcdoc += "<\/body><\/html>" ;
                    f.srcdoc = srcdoc ;
                }
                else if (source.endsWith(".gif") || source.endsWith(".jpeg")  || source.endsWith(".jpg")) { 
                    // (animated) gif, jpeg image
                    f.srcdoc = "<html><img width=" + f.width + " height=" + f.height + " src='" + 
                    source + "'><\/html>" ;                 
                } 
                else { // default is html (may be implied index.html)
                    // srcdoc overrides src
                    f.removeAttribute("srcdoc") ;
                    f.src = source ;
                }

                // background colour
                background = conf.clips[i].background || conf.default.background ;
                document.body.style.backgroundColor = background ;

                // setup call to next change after duration
                duration = conf.clips[i].duration || conf.default.duration ;
                i = (i+1) % conf.clips.length ;
                setTimeout(change, duration * 1000) ;
            }

            var conf ;
            var query = window.location.search.substring(1) ;
            dataURL = query.split("=")[1]; // conf parameter
            // CORS is supported by github. Verify this with:
            // curl -I https://stevebattle.github.io/Pre5enter/Pre5enter.json
            //dataURL = "https://stevebattle.github.io/Pre5enter/Pre5enter.json" ;
            var f = document .getElementById("iframe");
            var i = 0;
            getJSON(dataURL, function(err, data) {
                if (err != null) {
                    alert('Cannot load Pre5enter configuration: ' + err);
                } else {
                    conf = data ;
                    change();
                }
            });
        </script>
    </body>
</html>
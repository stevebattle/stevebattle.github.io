<html>
<body>
<style>
video {
	transform: scale(-1, 1);
}

canvas {
	transform: scale(-1, 1);
}
</style>

<script src="../build/artoolkit.debug.js"></script>
<script src="../js/artoolkit.api.js"></script>

<div><video id="video"></video></div>
<div><canvas id="canvas"></canvas></div>

<script>

var tw = 1280 / 2;
var th = 720 / 2;

var hdConstraints = {
	audio: false,
	video: {
		mandatory: {
			maxWidth: tw,
			maxHeight: th
    	}
  	}
};

var detectedBarcodeMarkers = {};

var canvas = document.querySelector('canvas');
canvas.height = th;
canvas.width = tw;

// glMatrix matrices are flat arrays.
var tmp = new Float32Array(16);

function convertMarkerMatrix(arMat, glMat) {
  glMat[0] = arMat.m00;
  glMat[1] = -arMat.m10;
  glMat[2] = arMat.m20;
  glMat[3] = 0;
  glMat[4] = arMat.m01;
  glMat[5] = -arMat.m11;
  glMat[6] = arMat.m21;
  glMat[7] = 0;
  glMat[8] = -arMat.m02;
  glMat[9] = arMat.m12;
  glMat[10] = -arMat.m22;
  glMat[11] = 0;
  glMat[12] = arMat.m03;
  glMat[13] = -arMat.m13;
  glMat[14] = arMat.m23;
  glMat[15] = 1;
};

function multiplyMatrixAndPoint(matrix, point) {
  
  //Give a simple variable name to each part of the matrix, a column and row number
  var c0r0 = matrix[ 0], c1r0 = matrix[ 1], c2r0 = matrix[ 2], c3r0 = matrix[ 3];
  var c0r1 = matrix[ 4], c1r1 = matrix[ 5], c2r1 = matrix[ 6], c3r1 = matrix[ 7];
  var c0r2 = matrix[ 8], c1r2 = matrix[ 9], c2r2 = matrix[10], c3r2 = matrix[11];
  var c0r3 = matrix[12], c1r3 = matrix[13], c2r3 = matrix[14], c3r3 = matrix[15];
  
  //Now set some simple names for the point
  var x = point[0];
  var y = point[1];
  var z = point[2];
  var w = point[3];
  
  //Multiply the point against each part of the 1st column, then add together
  var resultX = (x * c0r0) + (y * c0r1) + (z * c0r2) + (w * c0r3);
  
  //Multiply the point against each part of the 2nd column, then add together
  var resultY = (x * c1r0) + (y * c1r1) + (z * c1r2) + (w * c1r3);
  
  //Multiply the point against each part of the 3rd column, then add together
  var resultZ = (x * c2r0) + (y * c2r1) + (z * c2r2) + (w * c2r3);
  
  //Multiply the point against each part of the 4th column, then add together
  var resultW = (x * c3r0) + (y * c3r1) + (z * c3r2) + (w * c3r3);
  
  return [resultX, resultY, resultZ, resultW];
}

navigator.mediaDevices.getUserMedia(hdConstraints).then(function success(stream) {
	var video = document.querySelector('video');
	video.srcObject = stream;
	video.play();

	var cameraParam = new ARCameraParam();
	cameraParam.onload = function() {
		var arController;

		var interval = setInterval(function() {
			if (!video.videoWidth)	return;
			canvas.width = video.videoWidth;
			canvas.height = video.videoHeight;

			if (!arController) {
				arController = new ARController(video, cameraParam);
				//arController.debugSetup();
				arController.setPatternDetectionMode( artoolkit.AR_MATRIX_CODE_DETECTION );
				arController.setMatrixCodeType(artoolkit.AR_MATRIX_CODE_4x4);

				arController.addEventListener('getMarker', function(ev) {
					var id = ev.data.marker.idMatrix;
					var index = ev.data.index;
					var pos = ev.data.marker.pos;
					var vertex = ev.data.marker.vertex;
					//console.log(pos[0],pos[1]);

					var ctx = canvas.getContext('2d');
					if (index==0) { // clear canvas if this is the first marker
						ctx.clearRect(0, 0, canvas.width, canvas.height);
					}

					if (id !== -1) {
						// plot ID
						ctx.save();
						ctx.translate(pos[0], pos[1]);
						// mirror text
						ctx.scale(-1, 1);
						ctx.font = "20px Arial";
						ctx.textAlign = 'center';
						ctx.textBaseline = 'middle'; 
						ctx.fillText(id, 0, 0);
						ctx.restore();

						// bounding box
						ctx.beginPath();
						ctx.moveTo(vertex[0][0], vertex[0][1]);
						ctx.lineTo(vertex[1][0], vertex[1][1]);
						ctx.lineTo(vertex[2][0], vertex[2][1]);
						ctx.lineTo(vertex[3][0], vertex[3][1]);
						ctx.closePath();
						ctx.stroke();

						var transform = ev.data.matrix;

						// line
						// https://www.html5rocks.com/en/tutorials/webgl/jsartoolkit_webrtc/
						// https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/Matrix_math_for_the_web
						convertMarkerMatrix(transform,tmp);
						ctx.save();
						ctx.translate(pos[0], pos[1]);
						ctx.beginPath();
						ctx.moveTo(0, 0);
						var point = [0,100,0,1];
						point = multiplyMatrixAndPoint(tmp,point);
						console.log(point[0],point[1]);
						ctx.lineTo(point[0],point[1]);
						ctx.stroke();
						ctx.restore();


						if (!detectedBarcodeMarkers[id]) {
							detectedBarcodeMarkers[id] = {
								visible: true,
								matrix: new Float32Array(16)
							}
						}
						detectedBarcodeMarkers[id].visible = true;
						detectedBarcodeMarkers[id].matrix.set(transform); // copy matrix
					}
				});
			}

			arController.process();
		}, 16);

	};
	cameraParam.src = 'Data/camera_para.dat';
});


function errorCallback(e) {
	console.log("Can't access user media", e);
}

</script>

</body>
</html>

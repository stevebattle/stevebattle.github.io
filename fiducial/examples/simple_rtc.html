<html>
<body>
<style>
video {
	transform: scale(-1, 1);
}

canvas {
	transform: scale(-1, 1);
}
</style>

<script src="../build/artoolkit.debug.js"></script>
<script src="../js/artoolkit.api.js"></script>

<div><video id="video"></video></div>
<div><canvas id="canvas"></canvas></div>

<script>

var tw = 1280 / 2;
var th = 720 / 2;

var hdConstraints = {
	audio: false,
	video: {
		mandatory: {
			maxWidth: tw,
			maxHeight: th
    	}
  	}
};

var detectedBarcodeMarkers = {};

var canvas = document.querySelector('canvas');
canvas.height = th;
canvas.width = tw;

navigator.mediaDevices.getUserMedia(hdConstraints).then(function success(stream) {
	var video = document.querySelector('video');
	video.srcObject = stream;
	video.play();

	var cameraParam = new ARCameraParam();
	cameraParam.onload = function() {
		var arController;

		var interval = setInterval(function() {
			if (!video.videoWidth)	return;
			canvas.width = video.videoWidth;
			canvas.height = video.videoHeight;

			if (!arController) {
				arController = new ARController(video, cameraParam);
				//arController.debugSetup();
				arController.setPatternDetectionMode( artoolkit.AR_MATRIX_CODE_DETECTION );
				arController.setMatrixCodeType(artoolkit.AR_MATRIX_CODE_4x4);

				arController.addEventListener('getMarker', function(ev) {
					var id = ev.data.marker.idMatrix;
					var index = ev.data.index;
					var pos = ev.data.marker.pos;
					var vertex = ev.data.marker.vertex;
					console.log(pos[0],pos[1]);

					var ctx = canvas.getContext('2d');

					if (index==0) { // clear canvas if this is the first marker
						ctx.clearRect(0, 0, canvas.width, canvas.height);
					}

					if (id !== -1) {
						// plot ID
						ctx.save();
						ctx.translate(pos[0], pos[1]);
						// mirror text
						ctx.scale(-1, 1);
						ctx.font = "20px Arial";
						ctx.textAlign = 'center';
						ctx.textBaseline = 'middle'; 
						ctx.fillText(id, 0, 0);
						ctx.restore();

						// bounding box
						ctx.beginPath();
						ctx.moveTo(vertex[0][0], vertex[0][1]);
						ctx.lineTo(vertex[1][0], vertex[1][1]);
						ctx.lineTo(vertex[2][0], vertex[2][1]);
						ctx.lineTo(vertex[3][0], vertex[3][1]);
						ctx.closePath();
						ctx.stroke();

						var transform = ev.data.matrix;
						if (!detectedBarcodeMarkers[id]) {
							detectedBarcodeMarkers[id] = {
								visible: true,
								matrix: new Float32Array(16)
							}
						}
						detectedBarcodeMarkers[id].visible = true;
						detectedBarcodeMarkers[id].matrix.set(transform); // copy matrix
					}
				});
			}

			arController.process();
		}, 16);

	};
	cameraParam.src = 'Data/camera_para.dat';
});


function errorCallback(e) {
	console.log("Can't access user media", e);
}

</script>

</body>
</html>

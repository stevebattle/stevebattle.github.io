<html>
 <head>
    <!-- see https://tonejs.github.io -->
    <script src="https://unpkg.com/@webcomponents/webcomponentsjs@^2/webcomponents-bundle.js"></script>
    <script src="https://unpkg.com/tone"></script>
    <script src="https://unpkg.com/@tonejs/ui"></script>
    <script src="https://www.puck-js.com/puck.js"></script>

    <script>
        const synth = new Tone.AMSynth().toMaster();
        var button = false;
        var b0 = false, b1;
        var cap,mincap=1000,maxcap=1000;
        var minhz = 27.5;
        var maxhz = 4186;
        // https://en.wikipedia.org/wiki/Moving_average#Exponential_moving_average
        var ema = 0;
        var weight = 0.1;
        var c1;

        function capmap(c) {
            var s = (c - mincap) / (maxcap - mincap);
            //console.log(c,s);
            return parseInt(minhz + s * (maxhz - minhz));
        }

        function getButtonValue() {
            Puck.eval("BTN.read()", function(v) { button = v; });
            //Puck.eval("digitalRead(D1)", function(v) { button = v; });
            //button = !button;
            //console.log(button);
            return button;
        }
        function start() {
            //Puck.write('LED1.reset();\n');
            setInterval(function loop() {
                c = getCap();
                ema = ema + weight*(c - ema);
                if (isNaN(ema)) {
                    ema = 0;
                }
                else if (ema<mincap) {
                    mincap = ema;
                }
                else if (ema>maxcap) {
                    maxcap = ema;
                }
                //b1 = getButtonValue();
                b0 = b1 = false;
                c1 = capmap(ema);
                console.log(ema,c1);
                if (!b0 && b1) {
                    synth.triggerAttack(c1);
                }
                else if (b0 && !b1) {
                    synth.triggerRelease();
                }
                else {
                    synth.setNote(c1);
                }
                b0 = b1;
            }, 100);
        }
        function getCap() {
            Puck.eval("Puck.capSense()", function(n) { cap = n; });
            return cap;
        }

    </script>
 </head>
 <body>
    <button onclick="start()">Connect</button>
    <button onclick="synth.triggerAttack(c1);">Play</button>
    <button onclick="synth.triggerRelease();">Mute</button>
</body>
</html>

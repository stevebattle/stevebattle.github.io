<html>
 <head>
    <!-- see https://tonejs.github.io -->
    <script src="https://unpkg.com/@webcomponents/webcomponentsjs@^2/webcomponents-bundle.js"></script>
    <script src="https://unpkg.com/tone"></script>
    <script src="https://unpkg.com/@tonejs/ui"></script>
    <script src="https://www.puck-js.com/puck.js"></script>

    <script>
        const synth = new Tone.AMSynth().toMaster();
        var button = false;
        var b0 = false, b1;
        var cap,mincap=0,maxcap=1000;
        var minhz = 27.5;
        var maxhz = 4186;

        function capmap(c) {
            var s = (c - mincap) / (maxcap - mincap);
            console.log(c,s);
            return parseInt(minhz + s * (maxhz - minhz));
        }

        function getButtonValue() {
            //Puck.eval("BTN.read()", function(v) { button = v; });
            Puck.eval("digitalRead(D1)", function(v) { button = v; });
            //console.log(button);
            return !button;
        }
        function start() {
            //Puck.write('LED1.reset();\n');
            setInterval(function loop() {
                c = getCap();
                b1 = getButtonValue();
                c1 = capmap(c);
                //console.log(c,c1);
                if (!b0 && b1) {
                    synth.triggerAttack(c1);
                }
                else if (b0 && !b1) {
                    synth.triggerRelease();
                }
                else {
                    synth.setNote(capmap(c1));
                }
                b0 = b1;
            }, 500);
        }
        function getCap() {
            Puck.eval("Puck.capSense()", function(n) { cap = n; });
            return cap;
        }

    </script>
 </head>
 <body>
    <button onclick="start()">Connect to BLE device.</button>
    <button onclick="mincap=getCap();">low</button>
    <button onclick="maxcap=getCap();">high</button>
</body>
</html>
